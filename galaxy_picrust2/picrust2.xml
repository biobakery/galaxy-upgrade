<tool id="picrust2" name="PICRUSt2" version="2.0.0" python_template_version="3.5">
	<description>Prediction of functional abundances based only on marker gene sequences</description>
    <requirements>
    </requirements>

	<command detect_errors="exit_code"><![CDATA[
		cp $input_abun  input_abun.biom &&
        picrust2_pipeline.py 
		-s $study_fasta 
		-i input_abun.biom  
		-o picrust2_out 
		--processes 10 
		--stratified &&
		gunzip picrust2_out/EC_predicted.tsv.gz &&
		cp picrust2_out/EC_predicted.tsv $EC_predicted &&
		gunzip picrust2_out/KO_predicted.tsv.gz &&
		cp picrust2_out/KO_predicted.tsv $KO_predicted &&
		zip -r  picrust2_out.zip  picrust2_out && 
		cp picrust2_out.zip  $picrust2_all_outputs &&
		gunzip picrust2_out/KO_metagenome_out/pred_metagenome_unstrat.tsv.gz &&
		cp pred_metagenome_unstrat.tsv.gz KO_metagenome_unstrat &&
		rm pred_metagenome_unstrat.tsv  && 
		gunzip picrust2_out/EC_metagenome_out/pred_metagenome_unstrat.tsv.gz &&
		cp pred_metagenome_unstrat.tsv.gz EC_metagenome_unstrat &&
		rm pred_metagenome_unstrat.tsv  && 
		gunzip picrust2_out/pathways_out/pred_metagenome_unstrat.tsv.gz &&
		cp pred_metagenome_unstrat.tsv.gz EC_pathways_unstrat &&
		rm pred_metagenome_unstrat.tsv  && 
		rm input_abun.biom &&
		rm -r picrust2_out
            ]]></command>

    <inputs>
        <param type="data" name="study_fasta"  label="FASTA of unaligned study sequences " format="fasta"  />
		<param type="data" name="input_abun"  label="Input table of sequence abundances" format="biom2"  />

    </inputs>
    
	<outputs>
        <data name="EC_predicted" format="tsv"  />
		<data name="KO_predicted" format="tsv"  />
		<data name="KO_metagenome_unstrat" format="tsv"  />
		<data name="EC_metagenome_unstrat" format="tsv"  />
		<data name="pathways_metagenome_unstrat" format="tsv"  />
	 	<data name="picrust2_all_outputs"  format="zip" label="Picrust2 Output zip results - please download" />
    </outputs>
   <help><![CDATA[
  

PICRUSt2 (Phylogenetic Investigation of Communities by Reconstruction of Unobserved States) is a software for predicting functional abundances based only on marker gene sequences.  

"Function" usually refers to gene families such as KEGG orthologs and Enzyme Classification numbers, but predictions can be made for any arbitrary trait. Similarly, predictions are typically based on 16S rRNA gene sequencing data, but other marker genes can also be used.

Please see the Picrust-Tutorial-How-To-Generate-Metagenome-Predictions_  , Picrust-FAQ_  and the Picrust-Google-Group_ for more detailed information

PICRUSt2 includes these and other improvements over the original version:

Allow users to predict functions for any 16S sequences. Representative sequences from OTUs or amplicon sequence variants (e.g. DADA2 and deblur output) can be used as input by taking a sequence placement approach
Database of reference genomes used for prediction has been expanded by >10X.
Addition of hidden-state prediction algorithms from the castor R package.
Allows output of MetaCyc ontology predictions that will be comparable with common shotgun metagenomics outputs.
Inference of pathway abundances now relies on MinPath, which makes these predictions more stringent.

.. image:: https://github.com/picrust/picrust2/wiki/images/PICRUSt2_flowchart.png
    :height: 600        
    :width: 700 



.. _Sample_Fasta:  https://github.com/biobakery/galaxy-upgrade/blob/main/galaxy_picrust2/test_data/study_seqs_test.fasta

.. _Sample_Sequence_Abundances:  https://github.com/biobakery/galaxy-upgrade/blob/main/galaxy_picrust2/test_data/workflow/workflow_seq_abun.biom

.. _Picrust-Tutorial-How-To-Generate-Metagenome-Predictions:  https://github.com/picrust/picrust2/wiki/PICRUSt2-Tutorial-(v2.5.0)#generate-metagenome-predictions 

.. _Picrust-FAQ: https://github.com/picrust/picrust2/wiki/Frequently-Asked-Questions

.. _Picrust-Google-Group: https://groups.google.com/g/picrust-users


**Inputs**
==========

Picrust2 requires two input files 

* FASTA of unaligned study sequences 

* Table of sequence abundances (biom or tsv)

Sample data is avalable using the following links:

* Sample_Fasta_

* Sample_Sequence_Abundances_

Please download the files to your PC and upload them to Galaxy using the "Get Data / Upload file" in Galaxy



**Outputs**
===========

We provide three outputs:
 
* EC predictions - in the "EC_predicted.tsv" file
* KO predictions - in the "KO_predicted.tsv" file
* A zip file containing all the files in the generated output directory
* A set of unstratified community-wide abundance tables:  KO, EC and pathways (All in tsv format)

..  _PICRUST2_wiki:  https://github.com/picrust/picrust2/wiki
..  _PICRUST2_Paper: https://www.nature.com/articles/s41587-020-0548-6
..  _PICRUST2_User_Forum: https://groups.google.com/forum/#!forum/picrust-users


**If you use this software, please cite:**
==========================================

PICRUSt2 for prediction of metagenome functions

Gavin M. Douglas, Vincent J. Maffei, Jesse R. Zaneveld, Svetlana N. Yurgel, James R. Brown, Christopher M. Taylor, Curtis Huttenhower & Morgan G. I. Langille 

https://www.nature.com/articles/s41587-020-0548-6

    ]]>
</help>
</tool>
